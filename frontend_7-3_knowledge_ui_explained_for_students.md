# Task 7.3: Knowledge Admin UI（ナレッジ管理画面）の仕組み - 初学者向け解説

## この画面で何ができるか？

Knowledge Admin UI（ナレッジ管理画面）は、**管理者専用**の画面です。

この画面では、次の3つのことができます：

1. **📋 一覧表示**: アップロードされたドキュメント（PDFやWordファイルなど）の一覧を見る
2. **🔍 検索**: ファイル名でドキュメントを検索する
3. **📄 詳細表示**: 選択したドキュメントの詳しい情報を見る

### なぜ「管理者専用」なのか？

この画面では、システム内のすべてのドキュメントを見ることができます。  
一般ユーザーには見せたくない情報もあるため、**管理者だけ**がアクセスできるようになっています。

管理者でない人がこの画面にアクセスしようとすると、自動的にチャット画面（`/chat`）に戻されます。

---

## 画面の構成 - 3つのパーツ

Knowledge Admin UI は、次の **3つのパーツ** で構成されています：

### 1. 🔍 検索フォーム（KnowledgeFilterFormComponent）

- **場所**: 画面の上部
- **役割**: ファイル名で検索するための入力欄
- **便利な機能**:
  - 文字を入力すると、自動的に検索してくれます（デバウンスという仕組み）
  - 入力を止めてから 0.3秒後に検索が始まります
  - クリアボタンで検索文字を一発で消せます

**仕組み（簡単に）**:
- ユーザーが検索欄に文字を入力
- 0.3秒待つ（入力が続いていたら待ち続ける）
- 入力が止まったら、親コンポーネント（KnowledgePage）に「検索してください」と伝える

### 2. 📋 ドキュメント一覧テーブル（KnowledgeListComponent）

- **場所**: 画面の左側
- **役割**: ドキュメントの一覧を表として表示
- **表示される情報**:
  - ファイル名（アイコン付き）
  - ファイルタイプ（PDF、Word など）
  - ファイルサイズ
  - アップロード日時
  - 詳細表示ボタン

**便利な機能**:
- **ソート**: 列の見出しをクリックすると、その列で並び替えできます
- **ページネーション**: ドキュメントが多い場合、ページごとに分けて表示されます（10件、25件、50件、100件から選べる）
- **ファイルアイコン**: ファイルタイプに応じて、分かりやすいアイコンが表示されます
  - PDF → 📄 アイコン
  - Word → 📝 アイコン
  - Excel → 📊 アイコン

### 3. 📄 詳細パネル（KnowledgeDetailComponent）

- **場所**: 画面の右側（ドキュメントを選択したときだけ表示）
- **役割**: 選択したドキュメントの詳しい情報を表示
- **表示される情報**:
  - ファイルID
  - ファイル名
  - ファイルタイプ
  - ファイルサイズ
  - アップロード日時
  - 更新日時
  - アップロードしたユーザーのID
  - アクティブ状態（有効/無効）

**P0（現在）とP1（将来）の違い**:
- **P0（今）**: ファイルの基本情報だけを表示
- **P1（将来）**: ファイルの中身（テキスト）も表示できるようになる予定

---

## データの流れ - どうやって情報を取得しているか？

### ステップ1: 画面を開いたとき

```
ユーザーが /knowledge にアクセス
↓
AdminGuard が管理者かチェック
↓（管理者の場合）
KnowledgePage が表示される
↓
KnowledgePage が ApiService に「ドキュメント一覧をください」とリクエスト
↓
ApiService が Backend サーバーに GET /api/admin/knowledge を送信
↓
Backend からドキュメント一覧が返ってくる
↓
KnowledgePage が一覧データを保存（Signals という仕組みを使用）
↓
KnowledgeList が一覧を表示
```

### ステップ2: 検索したとき

```
ユーザーが検索欄に「report」と入力
↓
KnowledgeFilterForm が 0.3秒待つ
↓
KnowledgeFilterForm が KnowledgePage に「"report"で検索してください」と伝える
↓
KnowledgePage が ApiService に「"report"というキーワードでドキュメントをください」とリクエスト
↓
ApiService が Backend に GET /api/admin/knowledge?search_query=report を送信
↓
Backend から検索結果が返ってくる
↓
KnowledgePage が一覧データを更新
↓
KnowledgeList が新しい一覧を表示（検索結果のみ）
```

### ステップ3: 詳細を表示したとき

```
ユーザーが一覧の「詳細を表示」ボタンをクリック
↓
KnowledgeList が KnowledgePage に「このIDのドキュメントを詳しく見せてください」と伝える
↓
KnowledgePage が ApiService に「このIDの詳細をください」とリクエスト
↓
【P0の実装】
ApiService は既に取得済みの一覧データから、そのIDを探す
（Backend への追加リクエストなし = 速い！）
↓
APIService が詳細データを返す
↓
KnowledgePage が詳細データを保存（Signals）
↓
KnowledgeDetail が詳細パネルを表示
```

---

## Signals による状態管理 - リアクティブな仕組み

### Signals とは？

Signals は、Angular の新しい機能で、**データが変わったら自動的に画面を更新してくれる仕組み**です。

例えば：
```typescript
documents = signal<KnowledgeDocument[]>([]);  // 空の配列から始まる

// データを更新
this.documents.set(newDocuments);  
// → 画面が自動的に更新される！
```

### KnowledgePage で使っている Signals

KnowledgePage では、次のような Signals を使っています：

1. **`documents`**: ドキュメント一覧
   - 一覧が読み込まれたら自動的に KnowledgeList が更新される

2. **`selectedDetail`**: 選択中のドキュメント詳細
   - ドキュメントを選択したら自動的に KnowledgeDetail が表示される

3. **`isLoading`**: 読み込み中かどうか
   - Backend からデータを取得中は `true`
   - 取得完了したら `false`
   - → プログレスバー（読み込み中の表示）が自動的に表示/非表示になる

4. **`error`**: エラー情報
   - エラーが発生したら、ユーザーにメッセージを表示

---

## エラーハンドリング - 何か問題が起きたときの対応

### エラーの種類

システムでは、次のようなエラーを区別しています：

| エラー種別 | 意味 | ユーザーへのメッセージ |
|-----------|------|----------------------|
| `network` | ネットワーク接続失敗 | 「インターネット接続を確認してください」 |
| `http-401` | ログインセッション切れ | 「もう一度ログインしてください」 |
| `http-403` | 管理者権限なし | 「この操作を行う権限がありません」 |
| `http-404` | データが見つからない | 「データが見つかりませんでした」 |
| `http-5xx` | サーバーエラー | 「サーバー側でエラーが発生しました」 |

### エラーが起きたときの流れ

```
何かエラーが発生
↓
ApiService がエラーを種類別に分類
↓
KnowledgePage がエラーを受け取る
↓
エラーの種類に応じた処理:
  - 401 → 再ログイン画面へ
  - 403 → 「権限なし」メッセージ + /chat へ戻す
  - その他 → エラーメッセージを表示
↓
ユーザーに Snackbar（画面下部の通知）でメッセージを表示
```

---

## AdminGuard - 管理者チェックの仕組み

### AdminGuard の役割

Knowledge Admin UI にアクセスできるのは**管理者だけ**です。  
これを守るのが `AdminGuard` です。

### 動作の流れ

```
ユーザーが /knowledge にアクセスしようとする
↓
AdminGuard が起動
↓
StateService から現在のユーザー情報を取得
↓
is_admin フラグをチェック:
  - is_admin === true → アクセス許可
  - is_admin === false → /chat へリダイレクト
```

---

## P0（現在）と P1（将来）の違い

### P0（PoC = 概念実証版）- 今の実装

- **一覧表示**: ✅ できる
- **検索**: ✅ できる
- **詳細表示**: ✅ できる（メタデータのみ）
- **ファイル内容プレビュー**: ❌ まだできない
- **ドキュメント追加**: ❌ まだできない
- **ドキュメント削除**: ❌ まだできない

### P1（本番版）- 将来の拡張

- **ファイル内容プレビュー**: ✅ PDFやWordの中身を表示できる
- **ドキュメント追加**: ✅ 管理者がファイルをアップロードできる
- **ドキュメント削除**: ✅ 不要なファイルを削除できる
- **詳細API**: Backend に `GET /api/admin/knowledge/{id}` が実装される
  - → P0 では一覧から探していたが、P1 では直接取得できる（より正確）

---

## まとめ

Knowledge Admin UI は、**3つのコンポーネント**（検索フォーム・一覧・詳細）が協力して動いています。

- **Signals** のおかげで、データが変わったら自動的に画面が更新されます
- **AdminGuard** のおかげで、管理者だけがアクセスできます
- **詳細なエラー処理** のおかげで、問題が起きても分かりやすいメッセージが表示されます

P0 では基本機能のみですが、P1 でファイル内容プレビューや編集機能が追加される予定です！
