## DOM Enterprise Gateway / PoC Core Chat

**引き継ぎメモ & 要件フルサマリ v1.1**  
（Ephemeral RAG / Markdown IC-5 / 強制リセット / 初期管理者 / リサーチモード 反映版）

> このドキュメントを別スレッドの一番最初に貼ると、  
> どの GPT / LLM でも「この状態から」設計・実装を再開できることを目的としています。

---

### 0. このドキュメントの使い方（引き継ぎメモとして）

1. **新しいスレッドを開いたら、まずこの全文を貼る。**
2. そのうえで、次のように指示する：

   - 「この仕様の `requirements_p0_core_chat` を前提に、～をしてほしい」
   - 「Project Memory 4枚を、この仕様を元に生成してほしい」など
3. モデルが `DOM Enterprise Gateway` という名前・目的・制約を理解した前提で、
   詳細設計やコード生成に進ませる。

---

## 1. プロジェクト概要

### 1.1 名前と目的

- プロジェクト名: **DOM Enterprise Gateway**
- 目的:

  - エンタープライズ向けの **ガバナンス付き LLM ゲートウェイ** を PoC する。
  - マルチエージェント（DOM / Helper / Research / Answer）と
    **長期メモリ + LangChain v1 ベースの RAG** により、
    - 人間に近い文脈保持
    - 説明責任（トレース・ソース参照）
    を両立すること。
  - 将来的に **DeepSeek 小モデルを Helper として利用**し、商用 LLM（Gemini / GPT / Claude）と組み合わせる前提。

### 1.2 フェーズ

- **P0 = PoC Core Chat**（このドキュメントの主対象）

  - Gemini 無料枠を前提に、Main/Helper とも Gemini を使用。
  - DOM / Helper / Research / Answer の 4エージェント構成。
  - メモリ（Structured / Episodic）と RAG を最小実装。
  - 添付ファイルは **Ephemeral RAG**（セッション限定ベクトル検索）で利用。
  - 一部のユースケースで **リサーチモード（簡易エージェント）** を提供。

- **P1+**（このドキュメント内では「(P1)」と明記）

  - DeepSeek Helper 導入、複数 LLM 切り替え、本格的な AgentOps・ナレッジ運用・ポリシー管理など。
  - 高度な Agentic RAG / 自己改善ループ。

---

## 2. 使用技術・技術スタック

### 2.1 バックエンド

- 言語: **Python 3.12**
- フレームワーク: **FastAPI**
- LLM / RAG:

  - **LangChain v1** … RAG / Tool / Agent 実装に必須で採用
- ORM / Migration:

  - SQLAlchemy
  - Alembic（マイグレーション管理）

### 2.2 フロントエンド

- フレームワーク: **Angular**（最新版 LTS）
- i18n: Angular i18n または ngx-translate
- UI:

  - チャット画面（ストリーミング表示）
  - セッション一覧
  - メモリ画面
  - ナレッジ管理（管理者）
  - 設定画面（ユーザー設定 / 管理者設定）
  - ヘルプセンター画面

### 2.3 インフラ・その他

- DB: PostgreSQL 15+

  - pgvector 拡張 or 互換（knowledge_documents / Ephemeral RAG / 将来 episodic embedding）
- キャッシュ・一時ストア: Redis

  - Ephemeral Session Store
  - セッションロック（Reset 排他制御など）
- コンテナ:

  - Docker
  - docker-compose で PoC 全体を起動可能にする
- 認証:

  - OAuth2.0 + OIDC（Auth Code + PKCE 推奨）
  - 初期管理者メール `INITIAL_ADMIN_EMAIL` による admin ブートストラップ

### 2.4 LLM・エージェント

- PoC (P0):

  - Main LLM: Gemini
  - Helper LLM: Gemini
- LlmClient 抽象:

  ```text
  interface LlmClient {
    respond(prompt, options) -> { text, usage }
  }

  MainLlmClient: provider = gemini | gpt | claude (将来)
  HelperLlmClient: provider = gemini (PoC) | deepseek_local (本番想定)
````

* エージェント:

  * **DOM Meister** … 意図解析・タスク分解・ルーティング・モード選択（通常 / リサーチ）
  * **Helper Meister** … 要約・RAGクエリ生成・タグ付け・メモリ用整形
  * **Research Meister** … LangChain v1 RAG チェーン実行・証拠収集

    * P0: シングルターン RAG + リサーチモード時の限定的な複数ステップ
  * **Answer Meister** … IC-5 ライト形式（Markdown）で最終回答を整形

---

## 3. アーキテクチャ概要

### 3.1 コンポーネント構成

1. **Angular Frontend**

   * チャット画面
   * セッション一覧
   * メモリ画面
   * ナレッジ管理（管理者のみ）
   * 設定画面（ユーザー / 管理者）
   * ヘルプセンター
   * 「高度リサーチモード」トグル表示

2. **FastAPI Backend**

   * `/api/auth/*` … OAuth2/OIDC 連携
   * `/api/chat/*` … チャット送受信・ストリーミング・reset・リサーチモード
   * `/api/files/*` … ファイルアップロード（セッション添付）
   * `/api/memory/*` … Structured / EpisodicMemory 操作・検索
   * `/api/admin/knowledge/*` … ナレッジ一覧・詳細（管理者）
   * `/api/user/settings` … ユーザー設定
   * `/api/admin/tenant-settings` … テナント設定（P1）
   * `/api/help/content` … ヘルプコンテンツ（静的でも可）

3. **Orchestration 層（Python パッケージ）**

   * `DomOrchestrator` … モード選択（通常 / リサーチ）とタスク分解
   * `HelperAgent`
   * `ResearchAgent`
   * `AnswerAgent`
   * `LlmClient`（Main / Helper）

4. **共通サービス**

   * `MemoryService` … Structured / Episodic / Ephemeral
   * `RagService` … LangChain v1 ベース RAG チェーン
   * `EphemeralRagService` … `session_id` 単位の一時ベクトルインデックス管理
   * `PiiService` … PII マスク / トークン化
   * `AgentOpsService` … agent_runs / feedback_events の記録
   * `FileService` … セッションファイルの保存・削除・メタ情報管理

5. **データストア**

   * PostgreSQL:

     * テナント・ユーザー・セッション・メモリ・ナレッジ・設定・ログ
   * ベクトルストア:

     * pgvector（knowledge_documents 用）
     * Ephemeral RAG は、in-memory or pgvector の一時テーブルを利用（P0でもよい）
   * Redis:

     * Ephemeral Session Store
     * セッションロック（Reset 排他制御など）

---

## 4. 機能要件（FR）概観

ここでは `requirements_p0_core_chat.md` の要約だけ記載し、詳細はそちらを参照する想定。

### 4.1 認証・認可・テナント

* **FR-AUTH-1 (P0)** OAuth2 / OIDC 認証
* **FR-AUTH-2 (P0)** RBAC / テナント分離
* **FR-AUTH-3 (P0)** `INITIAL_ADMIN_EMAIL` による初期 admin 自動登録

### 4.2 コアチャット・オーケストレーション

* **FR-CHAT-1 (P0)** チャット送受信 / ストリーミング
* **FR-CHAT-2 (P0)** IC-5 ライト形式回答（Markdown の `## Decision / ## Why / ## Next 3 Actions` セクション）
* **FR-CHAT-3 (P1)** IC-5 フル形式（Options / Risks 追加）

### 4.3 RAG / エージェント関連

* **FR-RAG-1 (P0)** LangChain v1 ベース シングルターン RAG
* **FR-RAG-2 (P0)** ソース種別の明示（RAG / Memory / Assumption / Web）
* **FR-RAG-EPH-1 (P0)** Ephemeral RAG（セッション限定のベクトルインデックス）
* **FR-AGENT-1 (P0)** リサーチモード（簡易エージェント）

  * トグル or `/research` で有効化
  * DOM プランニング + Helper クエリ生成 + Research 複数検索 + Answer 統合
* **FR-RAG-3 (P1)** 高度な Agentic RAG（自律ループつき）

### 4.4 ファイルアップロード・セッション添付・ナレッジ

* **FR-FILE-1 (P0)** セッションへのファイル添付

  * 最大 10 ファイル / 1 ファイル 5MB / 合計 15MB（変更可能）
  * Ephemeral RAG に登録して利用
* **FR-FILE-2 (P0)** サポートファイル形式

  * `.pdf` / `.txt` / `.md` / `.docx` / `.pptx` / `.xlsx`
* **FR-FILE-3 (P1)** ナレッジ登録フロー（RAG 用）
* **FR-KB-1〜3 (P0)** ナレッジ一覧・詳細・検索（管理者画面）
* **FR-KB-DEL-1 (P1)** ソフトデリート
* **FR-KB-VERS-1 (P1)** バージョン管理

### 4.5 メモリ・Reset

* **FR-MEM-1〜3 (P0)** 短期 / Structured / Episodic メモリ
* **FR-MEM-SEARCH-1 (P0)** EpisodicMemory 検索
* **FR-RESET-1 (P0)** 保存して終了 / 保存せず終了
* **FR-RESET-2 (P0)** Reset インバリアント（保存成功しない限り short-term を消さない）
* **FR-RESET-3 (P0)** 保存せず強制リセット（保存エラー多発時の救済ルート）

### 4.6 フィードバック・AgentOps

* **FR-FEED-1 (P0)** 👍/👎 + コメント
* **FR-FEED-2 (P1)** AgentOps ダッシュボード

### 4.7 設定 / i18n / ヘルプ

* **FR-SET-USER-1〜2 (P0〜P1)** ユーザー設定（フォント / テーマ / 言語 / LLM プロファイル）
* **FR-SET-ADMIN-1〜2 (P1)** テナント設定・レート制御
* **FR-I18N-1 (P0)** UI i18n 基盤（日本語優先 + 英語）
* **FR-HELP-1〜6 (P0)** ヘルプセンター / オンボーディング / エラーとヘルプ連携
* **FR-HELP-7〜8 (P1)** 管理者向けヘルプ / ヘルプ内検索

### 4.8 セキュリティ・安全性

* **FR-SAFE-1 (P0)** コンテンツ安全ポリシー
* **FR-PROMPT-VERS-1 (P0)** Prompt / Policy バージョン管理
* **FR-TOOL-GOV-1 (P1)** ツール権限ガバナンス
* **FR-OFFBOARD-1 (P1)** テナント終了・データ削除ポリシー

---

## 5. 非機能要件（NFR）サマリ

* 性能:

  * 通常モード: 応答開始 2〜5 秒目標
  * リサーチモード: 複数ステップ前提のため若干遅くなり得るが、インジケータ表示で UX を担保
* 信頼性:

  * 営業時間中の安定稼働
  * Reset 排他制御とインバリアント + 強制リセット
* セキュリティ:

  * At-Rest 暗号化
  * PII フィルタ（外部 LLM / ログにはマスク済みのみ）
  * シークレット管理（環境変数 / Secrets Manager）
* エラー処理:

  * カテゴリ別エラーコード
  * `except Exception: pass` 禁止
  * 共通エラーハンドラ + ログ出力
* ログ / Observability:

  * trace_id 付与
  * PII マスキングログ
  * P1 以降でメトリクス収集
* スキーマ / デプロイ:

  * Alembic による管理
  * 非破壊的変更優先
  * docker-compose で一発起動
  * dev/stg/prod 分離

---

## 6. データモデル・テーブル定義サマリ（P0）

（詳細は `requirements_p0_core_chat.md` の 6章を参照）

* コア:

  * `tenants`, `users`, `user_settings`
* チャット:

  * `chat_sessions`, `chat_messages`, `session_files`
* メモリ:

  * `structured_memory`, `episodic_memory`
* ナレッジ:

  * `knowledge_documents` (+ ベクトルストア)
* AgentOps:

  * `agent_runs`, `agent_tool_calls`, `feedback_events`
* 設定・監査:

  * `tenant_settings`, `explanation_objects`, `audit_logs`

---

## 7. Project Memory 4枚との対応

このプロジェクトでは、次の 4 ドキュメントを「Project Memory」として使う想定です：

1. `architecture.md`
2. `tech-stack.md`
3. `coding-standards.md`
4. `llm-policy.md`

### 7.1 architecture.md（構造）

* 抽出ポイント:

  * コンポーネント構成（Frontend / Backend / Orchestration / Services / DB / Redis / Ephemeral RAG）
  * エージェント構成（DOM / Helper / Research / Answer）
  * 主なデータフロー：

    * 通常モード: チャット → DOM → Helper → RAG → Answer
    * リサーチモード: チャット → DOM（プラン）→ Helper（クエリ変形）→ Research（複数 RAG）→ Answer
  * C4 レベルの説明（コンテナ図・コンポーネント図）

### 7.2 tech-stack.md（技術スタック）

* 抽出ポイント:

  * Python 3.12 / FastAPI / LangChain v1
  * Angular / i18n
  * PostgreSQL / pgvector / Redis / Docker / docker-compose
  * OAuth2 / OIDC + INITIAL_ADMIN_EMAIL
  * Ephemeral RAG の実装選択肢（in-memory or pgvector）

### 7.3 coding-standards.md（コーディング規約）

* AI駆動開発_共通ガイドライン + プロジェクト固有要件：

  * `except Exception: pass` 禁止
  * クラス・メソッド・関数には初心者にも分かる docstring コメント

    * 引数・戻り値・役割を明示
  * Python 3.12 の型ヒント利用
  * エラーハンドリング指針（NFR-ERR）を反映
  * ログ出力時の PII マスキングルール
  * テスト方針（重要ロジックにはテスト or テストシナリオを用意）

### 7.4 llm-policy.md（LLM 利用方針）

* 抽出ポイント:

  * PoC では Gemini のみ（Main / Helper）
  * 将来の DeepSeek Helper / GPT / Claude の導入を想定
  * RAG / Web / メモリ / 外部API に出して良い情報（PII フィルタ必須）
  * Safety ポリシー（危険カテゴリへの対応）
  * Prompt / Policy バージョン管理戦略（FR-PROMPT-VERS-1）
  * リサーチモード利用時の追加コスト・レイテンシに関する注意点

---

## 8. 別スレッドで再開するときのテンプレ

> これは「DOM Enterprise Gateway / PoC Core Chat」の引き継ぎメモです。
> `requirements_p0_core_chat` としてこの仕様を前提に、
> FastAPI + Angular + LangChain v1 + Gemini を用いた PoC 実装支援をして下さい。
> 併せて、architecture.md / tech-stack.md / coding-standards.md / llm-policy.md の Project Memory 4枚を、
> この仕様（v1.1: Ephemeral RAG / リサーチモード / 強制リセット 反映済み）に整合する形で生成・更新する前提で考えて下さい。

