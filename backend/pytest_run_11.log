============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-8.4.2, pluggy-1.6.0
rootdir: /home/masahiro/work/dom-enterprise-gateway/backend
configfile: pyproject.toml
plugins: langsmith-0.4.55, anyio-4.12.0, asyncio-0.23.8
asyncio: mode=Mode.STRICT
collected 54 items

app/tests/test_auth_service.py ......                                    [ 11%]
app/tests/test_chat_service.py ...                                       [ 16%]
app/tests/test_dom_orchestrator_service.py ...                           [ 22%]
app/tests/test_endpoints_admin.py ...                                    [ 27%]
app/tests/test_endpoints_auth.py .....                                   [ 37%]
app/tests/test_endpoints_chat.py .......                                 [ 50%]
app/tests/test_endpoints_feedback.py .....                               [ 59%]
app/tests/test_endpoints_files.py ..F.                                   [ 66%]
app/tests/test_main.py .                                                 [ 68%]
app/tests/test_memory_service.py .......                                 [ 81%]
app/tests/test_rag_service.py .F.F                                       [ 88%]
app/tests/test_repositories.py ......                                    [100%]

=================================== FAILURES ===================================
_________________________ test_upload_file_no_filename _________________________

override_get_current_user = None, override_get_file_service = None
override_get_knowledge_document_repository = None
override_get_rag_service = None

    @pytest.mark.asyncio
    async def test_upload_file_no_filename(
        override_get_current_user,
        override_get_file_service,
        override_get_knowledge_document_repository,
        override_get_rag_service,
    ):
        """
        ファイル名がない場合のアップロード失敗ケースをテストします。
        """
        response = client.post(
            "/api/v1/files/upload",
            files={"file": ("", BytesIO(b"content"), "text/plain")}
        )
>       assert response.status_code == 400
E       assert 422 == 400
E        +  where 422 = <Response [422 Unprocessable Entity]>.status_code

app/tests/test_endpoints_files.py:205: AssertionError
________________________________ test_query_rag ________________________________

rag_service = <app.services.rag_service.RagService object at 0x7f1def583ef0>
mock_chat_google_generative_ai = <MagicMock name='ChatGoogleGenerativeAI' spec='ChatGoogleGenerativeAI' id='139766542862288'>

    @pytest.mark.asyncio
    async def test_query_rag(rag_service, mock_chat_google_generative_ai):
        """query_ragメソッドのテスト"""
        test_question = "What is RAG?"
        expected_answer = "RAG is Retrieval Augmented Generation."
    
        # LCELチェーン内のLLMのinvokeをモック
        mock_chat_google_generative_ai.return_value.ainvoke.return_value = expected_answer
    
        # Retrieverのget_relevant_documentsもモック
        rag_service.global_retriever.aget_relevant_documents.return_value = [
            Document(page_content="RAG combines retrieval and generation.")
        ]
    
        answer = await rag_service.query_rag(test_question)
        assert answer == expected_answer
    
        # retrieverが呼ばれたことを確認 (LCEL内部で発生)
>       rag_service.global_retriever.aget_relevant_documents.assert_awaited_once()

app/tests/test_rag_service.py:100: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <AsyncMock name='PGVector().as_retriever().aget_relevant_documents' id='139766546308592'>

    def assert_awaited_once(self):
        """
        Assert that the mock was awaited exactly once.
        """
        if not self.await_count == 1:
            msg = (f"Expected {self._mock_name or 'mock'} to have been awaited once."
                   f" Awaited {self.await_count} times.")
>           raise AssertionError(msg)
E           AssertionError: Expected aget_relevant_documents to have been awaited once. Awaited 0 times.

/usr/lib/python3.12/unittest/mock.py:2305: AssertionError
___________________________ test_stream_rag_response ___________________________

rag_service = <app.services.rag_service.RagService object at 0x7f1df4a50170>
mock_chat_google_generative_ai = <MagicMock name='ChatGoogleGenerativeAI' spec='ChatGoogleGenerativeAI' id='139766635235088'>

    @pytest.mark.asyncio
    async def test_stream_rag_response(rag_service, mock_chat_google_generative_ai):
        """stream_rag_responseメソッドのテスト"""
        test_question = "Stream this."
        stream_chunks = ["First", "Second", "Third"]
    
        # LCELチェーン内のLLMのastreamをモック
        async def mock_llm_stream():
            for chunk in stream_chunks:
                yield chunk
        mock_chat_google_generative_ai.return_value.astream.return_value = mock_llm_stream()
    
        mock_chat_google_generative_ai.return_value.astream.return_value = mock_llm_stream()
    
        rag_service.global_retriever.aget_relevant_documents.return_value = [] # ダミー
    
        received_chunks = []
        async for chunk in rag_service.stream_rag_response(test_question):
            received_chunks.append(chunk)
    
>       assert received_chunks == stream_chunks
E       AssertionError: assert [] == ['First', 'Second', 'Third']
E         
E         Right contains 3 more items, first extra item: 'First'
E         Use -v to get more diff

app/tests/test_rag_service.py:131: AssertionError
=============================== warnings summary ===============================
app/schemas/auth.py:4
  /home/masahiro/work/dom-enterprise-gateway/backend/app/schemas/auth.py:4: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class AuthenticatedUser(BaseModel):

app/schemas/chat.py:15
  /home/masahiro/work/dom-enterprise-gateway/backend/app/schemas/chat.py:15: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ChatMessageResponse(BaseModel):

app/schemas/chat.py:36
  /home/masahiro/work/dom-enterprise-gateway/backend/app/schemas/chat.py:36: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ChatSessionResponse(BaseModel):

app/schemas/file.py:5
  /home/masahiro/work/dom-enterprise-gateway/backend/app/schemas/file.py:5: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class FileUploadResponse(BaseModel):

app/schemas/feedback.py:16
  /home/masahiro/work/dom-enterprise-gateway/backend/app/schemas/feedback.py:16: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class FeedbackResponse(BaseModel):

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED app/tests/test_endpoints_files.py::test_upload_file_no_filename - asse...
FAILED app/tests/test_rag_service.py::test_query_rag - AssertionError: Expect...
FAILED app/tests/test_rag_service.py::test_stream_rag_response - AssertionErr...
=================== 3 failed, 51 passed, 5 warnings in 1.89s ===================
