# DOM Enterprise Gateway – Product Steering (P0 / PoC)

## 1. プロダクト概要

### 1.1 プロダクト名（作業名）
- **DOM Enterprise Gateway**
- エンタープライズ向けの **ガバナンス付き LLM ゲートウェイ**。
- P0 では「コアチャット＋RAG＋メモリ＋最低限の管理機能」を PoC として実装する。

### 1.2 目的・ゴール
- 企業内ユーザーが、安心して LLM を活用できる「安全な入口」を提供する。
- 単なるチャットボットではなく、
  - マルチエージェント（DOM Orchestrator＋Helper＋Research＋Answer）、
  - 多段メモリ（Structured / Episodic / Ephemeral）、
  - Explainability（参照ソース・メモリ・ポリシーのトレース）
  を組み合わせ、「人間に近い文脈保持」と「説明責任」を両立する。
- P0 の時点で、以下を満たすことを PoC 成功条件とする：
  - 1 つのテナントで、少人数ユーザーが日常の調査・設計・文章作成に継続利用できる。
  - 重要な会話・方針が Structured / EpisodicMemory に保存され、再利用できる。
  - 管理者が、ナレッジや長期メモリの内容・利用状況を安全に把握できる。

### 1.3 ターゲットユーザー
- 社内の **開発者・アーキテクト・コンサル・プロジェクトマネージャー**。
- LLM への理解がある程度あるが、  
  「個人でバラバラに使うのではなく、組織としてコントロールされた形で使いたい」層。
- 一般社員向けの“AIポータル”は対象外（P1 以降で検討）。

---

## 2. フェーズ定義とスコープ

### 2.1 フェーズ

- **P0 = PoC / Core Chat**
  - 本ドキュメントの対象。Gemini 無料枠を中心に構成。
- **P1 = v1 本番**
  - 複数 LLM プロバイダ、DeepSeek Helper、より高度な RAG・メモリ運用、AgentOps ダッシュボードなど。
- **P2+**
  - 自己改善を含む Agentic RAG、本格的なポリシー管理、ワークフロー連携など。

### 2.2 P0 で実現する機能（必須）

1. **チャット / IC-5 ライト**
   - 自然言語での指示・質問に対し、ストリーミングで回答。
   - 出力は基本日本語（です・ます）で、
     - Decision
     - Why
     - Next 3 Actions  
     を含む IC-5 ライト版を標準とする。

2. **マルチエージェント構成（ライト版）**
   - Domain Orchestrator Meister（DOM）
   - Helper Meister（要約・前処理・RAG クエリ生成）
   - Research Meister（RAG＋必要に応じた追加探索）
   - Answer / Composer Meister（最終回答整形）
   - P0 では「自律ループは短いステップに限定した Agentic RAG」に留め、  
     無限ループを避けるためのステップ数上限を設ける。

3. **RAG / Ephemeral RAG**
   - LangChain v1 ベースの RAG による社内ナレッジ検索。
   - **Ephemeral RAG（セッション限定インデックス）**：
     - ユーザーがセッション内でアップロードしたファイルを、
       そのセッション専用のベクトルインデックスに登録し、回答に利用する。
     - セッション終了時に、Ephemeral インデックスはクリーンアップされる（長期保存しない）。

4. **メモリ機構**
   - StructuredMemory:
     - テナント／ユーザー／プロジェクトに紐づく設定・プロファイル・方針などの構造化メモリ。
   - EpisodicMemory:
     - セッション終了時に「要約＋決まったこと＋今後の前提」を保存。
   - Ephemeral Session Store:
     - タイムアウトやブラウザクラッシュ後に、短時間だけセッションを復元するための一時ストア。
   - **Reset インバリアント**：
     - `/reset` 実行時は「要約の保存が成功した場合にのみ短期メモリをクリア」する。
     - 保存に失敗した場合は、リセット処理を中止し、セッションを維持したままユーザーに通知する。
     - さらに、要約生成自体が失敗し続ける場合に備え、
       「ユーザーの明示同意を得たうえで、保存せずに強制リセットする」救済ルートを用意する。

5. **ファイル添付と制限**
   - 1 セッションあたり：
     - 最大 **10 ファイル**
     - 合計サイズ上限（例: **30MB**）  
       → 上限は設定値として変更可能にする。
   - 上限を超える場合、アップロードを拒否し、エラーメッセージで理由を明示する。
   - 対応ファイル種別:
     - PDF, Markdown, テキスト, Office（docx, xlsx, pptx）を優先（将来拡張可）。
   - PDF など日本語文書は、文字化け（「■」）を防ぐため、
     - UTF-8／Unicode ベースでテキスト抽出するライブラリ／設定を採用する。

6. **ガバナンス / Explainability / ログ**
   - 各回答に対して：
     - 参照ソース（RAG / Web / Memory / Assumption）の一覧を添付。
   - 管理者向けには、Explanation Object（内部 IC-5 / ミニレビュー）の閲覧機能を後続フェーズで追加可能にする。
   - 重要操作（reset、設定変更、ナレッジ操作など）は監査ログに記録。

7. **ナレッジ / 長期メモリ管理**
   - 管理者画面から：
     - ナレッジ・ドキュメントの一覧／詳細閲覧
     - 検索（タイトル・タグ・アップロード者・日付など）
     - 削除・無効化・再インデックス
     - 同一ファイルのアップロード時に「上書き／別バージョンとして保存」の選択
   - 長期メモリ（Structured/Episodic）についても、管理者が検索・参照できる（P0 では最低限）。

8. **ヘルプセンター / オンボーディング**
   - ユーザー向けヘルプ画面：
     - 初回利用ガイド
     - 「良い質問のしかた」「NGな入力例（PIIなど）」など。
   - チャット画面からいつでも開けるヘルプパネル／ショートカット。
   - ユーザーの 👍/👎 フィードバックを AgentOps 評価データとして保存（P0 は保存のみ）。

9. **国際化 (i18n)**
   - UI は日本語をデフォルトとし、英語 UI オプションへ拡張可能な i18n 設計とする。
   - 文言は i18n リソースファイルで管理し、ハードコードを避ける。

10. **セキュリティ / コンプライアンス**
    - OAuth2.0 認証（ID プロバイダ連携）＋ RBAC。
    - PII マスキングとテナント分離（RAG・メモリ双方）。
    - 保存データは At-Rest 暗号化、通信は TLS。

---

## 3. P0 でやらないこと（非スコープ）

- 複数テナント間の本格的な料金課金・請求連携。
- 組織横断の高度なワークフロー連携（Slack/Teams への自動投稿など）。
- 本番規模の高可用クラスタリング（PoC では単一ノード前提）。
- すべての従業員を対象にした大規模展開（P1 以降）。

---

## 4. 代表的なユーザーストーリー（P0）

1. **プロジェクトリードが設計相談をする**
   - 要件イメージを DOM Enterprise Gateway に投げる。
   - RAG で既存の社内ガイドライン・設計例を参照したうえで、IC-5 ライトで提案を受ける。
   - セッション終了時に「決まった方針」と「TODO」が EpisodicMemory に保存され、  
     次回の会話で自動的に候補として提示される。

2. **管理者がナレッジと長期メモリを確認する**
   - 管理画面から、アップロードされたナレッジ一覧とメタデータを閲覧。
   - 古くなったドキュメントを無効化（検索対象から除外）。
   - 特定ユーザーやプロジェクトの EpisodicMemory を検索し、活用状況を把握する。

3. **ユーザーがファイル付きの調査を行う**
   - PDF の調査資料を複数添付（合計サイズが上限以下）。
   - Ephemeral RAG でセッション限定インデックスを作成し、  
     「この資料を前提にした比較表を作って」と依頼。
   - セッション終了後、添付ファイルは Ephemeral インデックスから削除される。

---

## 5. PoC 成功指標（例）

- UX:
  - 社内テストユーザー数名が、**1週間以上日常的に利用**している。
  - 「レスポンスの速さ」「使いやすさ」について平均 4/5 以上の満足度。
- 技術:
  - Docker 上で `docker-compose up` により環境を一発起動できる。
  - RAG / メモリ / Reset インバリアント / ファイル添付 / ヘルプ画面が要件どおり動作する。
- ガバナンス:
  - 監査ログとテナント分離が確認でき、  
    「この回答はどのナレッジ／メモリに基づいたか」を追える。
